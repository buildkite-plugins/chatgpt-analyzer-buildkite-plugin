#!/bin/bash

set -euo pipefail

DIR="$(cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd)"

# shellcheck source=lib/plugin.bash
. "$DIR/../lib/plugin.bash"

echo "--- :robot_face: ChatGPT Analyzer Plugin"

# Validate required tools
validate_required_tools || exit 1

# Get required plugin configurations
echo "Retrieving OpenAI API Key ..."
# Read plugin configuration for OpenAI API Key
API_KEY=$(get_openai_api_key)
if [ -z "${API_KEY}" ]; then
  log_error 'Missing OpenAI API Key. Please set the API_KEY in your plugin configuration.'
  exit 1
fi   

echo "Retrieving other plugin configurations ..."
# Load Plugin configuration
BUILDKITE_API_TOKEN=$(get_bk_api_token) 
ANALYSIS_LEVEL=$(plugin_read_config ANALYSIS_LEVEL "step")
MODEL=$(plugin_read_config MODEL "gpt-5-nano")
CUSTOM_PROMPT=$(plugin_read_config CUSTOM_PROMPT "")

echo "Using Model: ${MODEL}"
echo "Using Custom Prompt: ${CUSTOM_PROMPT}"
echo "Analysis Level: ${ANALYSIS_LEVEL}"

# Summarize build information 
BUILD_SUMMARY=$(get_build_summary "${BUILDKITE_API_TOKEN}" "${ANALYSIS_LEVEL}") 
log_success "Done generating summary for this ${ANALYSIS_LEVEL}."
echo "${BUILD_SUMMARY}"
send_prompt "${API_KEY}" "${BUILD_SUMMARY}" "${MODEL}" "${CUSTOM_PROMPT}" "${ANALYSIS_LEVEL}"

echo "~~~ Done."